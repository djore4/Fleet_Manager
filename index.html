<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetWise v19 - Diagn√≥stico</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { margin: 0; font-family: sans-serif; background: #f4f4f4; }
        
        /* BARRA DE DIAGN√ìSTICO (O SEM√ÅFORO) */
        #status-bar {
            background-color: #dc3545; /* Come√ßa Vermelho */
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 9999;
        }

        /* LOGIN */
        #login-screen { display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; padding-top: 50px; }
        .box { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #333; color: white; border: none; font-weight: bold; cursor: pointer; font-size: 1.1rem; border-radius: 4px; }
        button:hover { background: #000; }
        
        /* APP (Escondida) */
        #app-content { display: none; padding: 20px; text-align: center; margin-top: 60px; }
    </style>
</head>
<body>

<div id="status-bar">üî¥ SISTEMA DESLIGADO (Se vires isto, o c√≥digo partiu)</div>

<div id="login-screen">
    <div class="box">
        <h2>FleetWise v19</h2>
        <input type="text" id="u" value="admin">
        <input type="password" id="p" value="123">
        <button onclick="tentarEntrar()">ENTRAR</button>
        <p id="msg" style="margin-top:15px; color:#666;">Aguarde pela barra verde...</p>
    </div>
</div>

<div id="app-content">
    <h1>üéâ SUCESSO!</h1>
    <p>O login funcionou e a base de dados respondeu.</p>
    <div style="background:white; padding:20px; border-radius:8px;">
        <h3>Dados na Base de Dados:</h3>
        <p>Viaturas: <span id="count-cars">...</span></p>
        <p>Pessoas: <span id="count-people">...</span></p>
    </div>
</div>

<script>
    // --- ZONA DE SEGURAN√áA ---
    // Se houver um erro, a barra fica vermelha e mostra o erro
    window.onerror = function(msg, url, line) {
        const bar = document.getElementById('status-bar');
        bar.style.backgroundColor = 'red';
        bar.innerText = "‚ùå ERRO CR√çTICO NA LINHA " + line + ": " + msg;
        return false;
    };

    // --- CONFIGURA√á√ÉO ---
    const supabaseUrl = 'https://qjzjxtxrlofnoyaaypbu.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqemp4dHhybG9mbm95YWF5cGJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzA0OTEsImV4cCI6MjA4MzMwNjQ5MX0.aKEIKjKpGbWJXNgephZV2T1yXpXXGJ0v3HpwHaR7HZE';
    
    let supabase = null;

    // --- INICIALIZA√á√ÉO ---
    // 1. Verificar se o Supabase carregou
    if (typeof window.supabase === 'undefined') {
        throw new Error("A biblioteca Supabase n√£o carregou. Verifica a internet.");
    }

    // 2. Iniciar Cliente
    supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // 3. SE CHEG√ÅMOS AQUI, TUDO EST√Å BEM!
    // Mudar sem√°foro para VERDE
    const bar = document.getElementById('status-bar');
    bar.style.backgroundColor = '#28a745';
    bar.innerText = "üü¢ SISTEMA ONLINE (Podes fazer Login)";

    // --- FUN√á√ÉO DO BOT√ÉO ---
    async function tentarEntrar() {
        const btn = document.querySelector('button');
        const msg = document.getElementById('msg');
        
        btn.innerText = "A verificar...";
        msg.innerText = "A contactar a Cloud...";

        const u = document.getElementById('u').value;
        const p = document.getElementById('p').value;

        if (u === 'admin' && p === '123') {
            try {
                // Testar conex√£o real
                const { count, error } = await supabase.from('fleet').select('*', { count: 'exact', head: true });
                
                if (error) throw error;

                // Sucesso
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('count-cars').innerText = count + " viaturas encontradas.";
                document.getElementById('count-people').innerText = "Liga√ß√£o OK.";
                
                bar.innerText = "üü¢ LOGIN EFETUADO COM SUCESSO";

            } catch (err) {
                alert("Erro ao ligar √† Cloud: " + err.message);
                msg.innerText = "Erro: " + err.message;
                btn.innerText = "TENTAR NOVAMENTE";
            }
        } else {
            alert("Senha errada!");
            btn.innerText = "ENTRAR";
        }
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetWise v20</title>

    <script>
        window.onerror = function(msg, url, line) {
            var bar = document.getElementById('status-bar');
            if(bar) {
                bar.style.backgroundColor = 'red';
                bar.innerHTML = "⚠️ ERRO NA LINHA " + line + ": " + msg;
                bar.style.display = 'block';
            }
            return false;
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { margin: 0; font-family: sans-serif; background: #eee; }
        #status-bar { background: #333; color: white; padding: 10px; text-align: center; font-weight: bold; position: fixed; top: 0; width: 100%; z-index: 9999; display:none;}
        
        #login-screen { height: 100vh; display: flex; align-items: center; justify-content: center; background: #017E84; }
        .box { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 350px; text-align: center; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing:border-box; }
        button { width: 100%; padding: 12px; background: #333; color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; font-size: 16px; }
        
        #app-content { display: none; padding: 20px; }
        .success-box { background: white; padding: 20px; border-radius: 8px; text-align: center; margin-top: 50px; }
    </style>
</head>
<body>

<div id="status-bar">A iniciar...</div>

<div id="login-screen">
    <div class="box">
        <h2>FleetWise v20</h2>
        <input type="text" id="u" value="admin">
        <input type="password" id="p" value="123">
        <button id="btn-entrar">ENTRAR</button>
    </div>
</div>

<div id="app-content">
    <div class="success-box">
        <h1 style="color:green; margin:0;">LOGIN SUCESSO!</h1>
        <p>A ligação à base de dados funciona.</p>
        <p>Viaturas encontradas: <b id="num-cars">...</b></p>
    </div>
</div>

<script>
    // Configuração
    const SUPABASE_URL = 'https://qjzjxtxrlofnoyaaypbu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqemp4dHhybG9mbm95YWF5cGJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzA0OTEsImV4cCI6MjA4MzMwNjQ5MX0.aKEIKjKpGbWJXNgephZV2T1yXpXXGJ0v3HpwHaR7HZE';

    // Verificar se o botão existe antes de usar
    const btn = document.getElementById('btn-entrar');
    if (btn) {
        btn.addEventListener('click', tentarLogin);
    }

    async function tentarLogin() {
        const u = document.getElementById('u').value;
        const p = document.getElementById('p').value;
        const status = document.getElementById('status-bar');

        if (u === 'admin' && p === '123') {
            status.style.display = 'block';
            status.style.backgroundColor = 'orange';
            status.innerText = "⏳ A ligar à Cloud...";

            try {
                if (typeof supabase === 'undefined') throw new Error("Supabase não carregou");
                
                const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // Teste Real
                const { count, error } = await client.from('fleet').select('*', { count: 'exact', head: true });
                
                if (error) throw error;

                // Sucesso
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('num-cars').innerText = count;
                status.style.display = 'none'; // Esconde barra

            } catch (err) {
                status.style.backgroundColor = 'red';
                status.innerText = "ERRO NA CLOUD: " + err.message;
            }
        } else {
            alert("Senha errada");
        }
    }
</script>

</body>
</html>

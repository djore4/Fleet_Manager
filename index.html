<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetWise Diagnóstico v26</title>
    
    <style>
        body { font-family: monospace; background: #222; color: #fff; padding: 20px; }
        .box { background: #333; padding: 20px; border: 1px solid #555; margin-bottom: 20px; }
        button { width: 100%; padding: 20px; background: #00ff00; color: black; font-weight: bold; font-size: 1.2rem; border: none; cursor: pointer; margin-top: 10px; }
        button:active { background: #fff; }
        .log { background: black; border: 1px solid #444; padding: 10px; height: 150px; overflow-y: scroll; font-size: 12px; color: #0f0; }
        .status { font-weight: bold; font-size: 1.2rem; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h2 style="margin-top:0">DIAGNÓSTICO</h2>
    
    <div class="box">
        <div id="status-text" class="status">A aguardar ação...</div>
        <div id="console-log" class="log">
            > Sistema iniciado.<br>
            > À espera que cliques no botão...
        </div>
        
        <button onclick="iniciarDiagnostico(this)">CLICAR PARA TESTAR</button>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // Função para escrever na caixa preta
        function log(msg) {
            const painel = document.getElementById('console-log');
            painel.innerHTML += "<br>> " + msg;
            painel.scrollTop = painel.scrollHeight;
        }

        // Se houver algum erro de sintaxe, apanha-o aqui
        window.onerror = function(msg, url, line) {
            log("❌ ERRO GRAVE DO NAVEGADOR: " + msg);
            document.getElementById('status-text').style.color = 'red';
            document.getElementById('status-text').innerText = "ERRO DETETADO";
            return false;
        };

        // A Função Principal
        async function iniciarDiagnostico(btn) {
            btn.style.backgroundColor = 'yellow';
            btn.innerText = "A TESTAR...";
            
            log("--------------------------------");
            log("1. Botão clicado com sucesso.");

            // TESTE 1: Verificar se a biblioteca Supabase carregou
            if (typeof window.supabase === 'undefined') {
                log("❌ FALHA: A biblioteca 'supabase' NÃO existe.");
                log("CAUSA: A tua rede ou AdBlock bloqueou o download do script.");
                log("SOLUÇÃO: Tenta noutra rede WiFi ou Dados Móveis.");
                
                document.getElementById('status-text').innerText = "BLOQUEIO DE REDE";
                document.getElementById('status-text').style.color = 'red';
                btn.style.backgroundColor = 'red';
                btn.innerText = "FALHA";
                return; // Pára aqui
            } else {
                log("✅ SUCESSO: Biblioteca Supabase carregada.");
            }

            // TESTE 2: Tentar ligar
            log("2. A tentar ligar à Cloud...");
            
            const SUPABASE_URL = 'https://qjzjxtxrlofnoyaaypbu.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqemp4dHhybG9mbm95YWF5cGJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzA0OTEsImV4cCI6MjA4MzMwNjQ5MX0.aKEIKjKpGbWJXNgephZV2T1yXpXXGJ0v3HpwHaR7HZE';

            try {
                const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // Pedir contagem simples
                const { count, error } = await client.from('fleet').select('*', { count: 'exact', head: true });

                if (error) {
                    throw error;
                }

                log("✅ SUCESSO TOTAL!");
                log("A base de dados respondeu: " + count + " viaturas.");
                document.getElementById('status-text').innerText = "LIGAÇÃO FUNCIONA!";
                document.getElementById('status-text').style.color = '#00ff00';
                btn.innerText = "TUDO OK";

            } catch (err) {
                log("❌ ERRO DE LIGAÇÃO: " + err.message);
                document.getElementById('status-text').innerText = "ERRO TÉCNICO";
                document.getElementById('status-text').style.color = 'red';
            }
        }
    </script>

</body>
</html>

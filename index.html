<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico FleetWise</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #222; color: #fff; font-size: 16px; }
        .success { color: #0f0; font-weight: bold; font-size: 20px; }
        .error { color: #f00; font-weight: bold; font-size: 20px; }
        .box { border: 1px solid #555; padding: 15px; margin-top: 20px; background: #000; }
    </style>
</head>
<body>

<h1>üïµÔ∏è Modo Detetive</h1>
<div id="status">A iniciar teste de liga√ß√£o...</div>

<div class="box">
    <p><strong>URL:</strong> <span id="url-check">...</span></p>
    <p><strong>KEY:</strong> <span id="key-check">...</span></p>
    <p><strong>Resultado da Base de Dados:</strong></p>
    <pre id="db-result">A aguardar...</pre>
</div>

<script>
    // AS TUAS CHAVES J√Å EST√ÉO AQUI:
    const supabaseUrl = 'https://qjzjxtxrlofnoyaaypbu.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqemp4dHhybG9mbm95YWF5cGJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzA0OTEsImV4cCI6MjA4MzMwNjQ5MX0.aKEIKjKpGbWJXNgephZV2T1yXpXXGJ0v3HpwHaR7HZE';

    const statusDiv = document.getElementById('status');
    const dbResult = document.getElementById('db-result');

    // 1. Verificar Chaves Visuais
    document.getElementById('url-check').innerText = supabaseUrl ? "OK (Definido)" : "ERRO (Vazio)";
    document.getElementById('key-check').innerText = supabaseKey ? "OK (Definido)" : "ERRO (Vazio)";

    async function runTest() {
        try {
            // 2. Verificar Biblioteca
            if (typeof supabase === 'undefined') {
                throw new Error("A biblioteca do Supabase n√£o carregou. Verifique a internet.");
            }

            // 3. Criar Cliente
            const client = supabase.createClient(supabaseUrl, supabaseKey);

            // 4. Testar Leitura da Tabela 'fleet'
            statusDiv.innerText = "A contactar a Cloud...";
            
            const { data, error } = await client.from('fleet').select('count', { count: 'exact', head: true });

            if (error) {
                throw error; // Lan√ßa o erro para o bloco catch
            }

            // SUCESSO
            statusDiv.innerHTML = '<span class="success">‚úÖ LIGA√á√ÉO BEM SUCEDIDA!</span><br>O sistema consegue falar com a base de dados.';
            dbResult.innerText = "Tudo OK. A tabela 'fleet' existe e est√° acess√≠vel.";
            
            // Bot√£o para carregar a App Real se tudo estiver bem
            dbResult.innerHTML += "<br><br>üëâ O problema era apenas cache ou c√≥digo antigo. Posso enviar o c√≥digo final agora?";

        } catch (err) {
            // ERRO
            console.error(err);
            statusDiv.innerHTML = '<span class="error">‚ùå FALHA NA LIGA√á√ÉO</span>';
            
            let msg = err.message;
            let solucao = "";

            if (msg.includes('relation "public.fleet" does not exist')) {
                solucao = "SOLU√á√ÉO: N√£o criaste as tabelas no Supabase SQL Editor. Tens de correr o c√≥digo SQL.";
            } else if (msg.includes('fetch')) {
                solucao = "SOLU√á√ÉO: Bloqueio de rede. Est√°s numa VPN ou rede de empresa?";
            } else {
                solucao = "SOLU√á√ÉO: Copia este erro e envia para o chat.";
            }

            dbResult.innerHTML = "ERRO T√âCNICO:\n" + msg + "\n\n" + solucao;
        }
    }

    // Iniciar teste
    runTest();

</script>
</body>
</html>
